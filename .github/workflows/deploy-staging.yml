name: Deploy to Staging

on:
  push:
    branches: [staging, develop]
  pull_request:
    branches: [staging]
    types: [closed]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  ECR_REPOSITORY: trendsearth-api-ui
  CODEDEPLOY_APPLICATION: trendsearth-api-ui
  CODEDEPLOY_DEPLOYMENT_GROUP: staging

jobs:
  build-and-deploy:
    name: Build and Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    concurrency:
      group: staging-deployment
      cancel-in-progress: false
    env:
      CODEDEPLOY_S3_BUCKET: ${{ secrets.CODEDEPLOY_S3_BUCKET }}
      ROLLBAR_ACCESS_TOKEN: ${{ secrets.ROLLBAR_ACCESS_TOKEN }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push image to ECR
      id: build-and-push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:staging
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.ref_name }}
        build-args: |
          GIT_BRANCH=${{ github.ref_name }}
          GIT_COMMIT=${{ github.sha }}
          DEPLOYMENT_ENVIRONMENT=staging
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Export image metadata
      id: build-image
      run: |
        ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
        IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
        echo "image=$IMAGE" >> $GITHUB_OUTPUT
        echo "registry=$ECR_REGISTRY" >> $GITHUB_OUTPUT

    - name: Create deployment bundle
      run: |
        # Create deployment bundle for CodeDeploy
        echo "üì¶ Creating deployment bundle..."
        
        # Create a clean directory for deployment
        mkdir -p deploy-bundle
        
        # Copy deployment files
        cp appspec.yml deploy-bundle/
        cp -r scripts/ deploy-bundle/
        cp docker-compose.prod.yml deploy-bundle/
        cp docker-compose.staging.yml deploy-bundle/
        
        # Create deployment info file
        cat > deploy-bundle/deployment-info.json <<EOF
        {
          "deploymentId": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "image": "${{ steps.build-image.outputs.image }}",
          "registry": "${{ steps.build-image.outputs.registry }}",
          "environment": "staging",
          "rollbarAccessToken": "${ROLLBAR_ACCESS_TOKEN}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        
        # Create deployment bundle
        cd deploy-bundle
        zip -r ../deployment-bundle.zip .
        cd ..
        
        echo "‚úÖ Deployment bundle created"

    - name: Upload bundle to S3
      env:
        S3_KEY: deployments/trendsearth-api-ui/staging/${{ github.sha }}/deployment-bundle.zip
      run: |
        # Upload deployment bundle to S3
        aws s3 cp deployment-bundle.zip "s3://$CODEDEPLOY_S3_BUCKET/$S3_KEY"
        
        echo "S3_BUCKET=$CODEDEPLOY_S3_BUCKET" >> $GITHUB_ENV
        echo "S3_KEY=$S3_KEY" >> $GITHUB_ENV

    - name: Cancel in-progress deployments
      run: |
        echo "üîç Checking for in-progress deployments..."
        
        # Get list of in-progress deployments for this deployment group
        IN_PROGRESS=$(aws deploy list-deployments \
          --application-name ${{ env.CODEDEPLOY_APPLICATION }} \
          --deployment-group-name ${{ env.CODEDEPLOY_DEPLOYMENT_GROUP }} \
          --include-only-statuses "InProgress" "Queued" "Created" \
          --query 'deployments' \
          --output text)
        
        if [ -n "$IN_PROGRESS" ] && [ "$IN_PROGRESS" != "None" ]; then
          echo "‚ö†Ô∏è Found in-progress deployments: $IN_PROGRESS"
          
          for DEPLOY_ID in $IN_PROGRESS; do
            echo "üõë Stopping deployment: $DEPLOY_ID"
            aws deploy stop-deployment \
              --deployment-id "$DEPLOY_ID" \
              --auto-rollback-enabled || echo "Could not stop $DEPLOY_ID (may have already completed)"
          done
          
          # Wait a moment for deployments to stop
          sleep 10
          echo "‚úÖ Cancelled previous in-progress deployments"
        else
          echo "‚úÖ No in-progress deployments found"
        fi

    - name: Create CodeDeploy deployment
      id: deploy
      run: |
        # Create CodeDeploy deployment
        echo "üöÄ Creating CodeDeploy deployment..."
        
        DEPLOYMENT_ID=$(aws deploy create-deployment \
          --application-name ${{ env.CODEDEPLOY_APPLICATION }} \
          --deployment-group-name ${{ env.CODEDEPLOY_DEPLOYMENT_GROUP }} \
          --s3-location bucket=$CODEDEPLOY_S3_BUCKET,key=$S3_KEY,bundleType=zip \
          --description "Staging deployment of commit ${{ github.sha }} from branch ${{ github.ref_name }}" \
          --query 'deploymentId' \
          --output text)
        
        echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
        echo "‚úÖ Deployment created: $DEPLOYMENT_ID"

    - name: Wait for deployment to complete
      env:
        DEPLOYMENT_ID: ${{ steps.deploy.outputs.deployment-id }}
      run: |
        echo "‚è≥ Waiting for deployment to complete..."
        echo "Deployment ID: $DEPLOYMENT_ID"
        
        # Wait for deployment to complete
        aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID
        
        # Get deployment status
        STATUS=$(aws deploy get-deployment \
          --deployment-id $DEPLOYMENT_ID \
          --query 'deploymentInfo.status' \
          --output text)
        
        echo "‚úÖ Deployment completed with status: $STATUS"

    - name: Verify deployment
      run: |
        echo "üîç Verifying staging deployment..."
        
        # Wait a bit for services to be fully ready
        sleep 30
        
        # Check health endpoint (this will be done by the validate script on the server)
        echo "‚úÖ Deployment verification will be handled by CodeDeploy validation hooks"

    - name: Notify Rollbar of deployment
      if: success()
      uses: rollbar/github-deploy-action@2.1.2
      with:
        environment: 'staging'
        version: ${{ github.sha }}
        status: 'succeeded'
        local_username: ${{ github.actor }}
      env:
        ROLLBAR_ACCESS_TOKEN: ${{ secrets.ROLLBAR_ACCESS_TOKEN }}
      continue-on-error: true

    - name: Notify Rollbar of deployment failure
      if: failure()
      uses: rollbar/github-deploy-action@2.1.2
      with:
        environment: 'staging'
        version: ${{ github.sha }}
        status: 'failed'
        local_username: ${{ github.actor }}
      env:
        ROLLBAR_ACCESS_TOKEN: ${{ secrets.ROLLBAR_ACCESS_TOKEN }}
      continue-on-error: true

    - name: Deployment summary
      run: |
        echo "üéâ Staging deployment completed successfully!"
        echo ""
        echo "üìã Deployment Details:"
        echo "  Commit: ${{ github.sha }}"
        echo "  Branch: ${{ github.ref_name }}"
        echo "  Image: ${{ steps.build-image.outputs.image }}"
        echo "  CodeDeploy ID: ${{ steps.deploy.outputs.deployment-id }}"
        echo "  Environment: staging"