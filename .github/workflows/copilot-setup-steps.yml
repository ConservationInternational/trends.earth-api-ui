name: "Trends.Earth API UI Development Environment Setup"

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: "Python version to use"
        required: false
        default: "3.12"
        type: choice
        options:
          - "3.11"
          - "3.12"
      install_browsers:
        description: "Install Playwright browsers"
        required: false
        default: true
        type: boolean

jobs:
  setup-environment:
    name: "Complete Development Environment Setup"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python_version }}
          cache: "pip"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Install Playwright browsers (optional)
        if: ${{ inputs.install_browsers != false }}
        run: |
          poetry run playwright install chromium --with-deps || true
          poetry run playwright --version || true
        timeout-minutes: 15

      - name: Verify core setup
        run: |
          poetry --version
          poetry run python --version
          poetry run python -c "import trendsearth_ui; print('ok')"

      - name: Verify Ruff
        run: |
          poetry run ruff --version
          echo 'print("hello")' > /tmp/t.py
          poetry run ruff check /tmp/t.py
          poetry run ruff format /tmp/t.py
          rm /tmp/t.py

      - name: Run a quick unit test
        run: |
          poetry run python -m pytest tests/unit/test_config.py -v --tb=short

      - name: Summary
        run: |
          echo "Setup complete"
          echo "Python: $(poetry run python --version)"
          echo "Poetry: $(poetry --version)"
          echo "Pytest: $(poetry run pytest --version)"
          echo "Ruff: $(poetry run ruff --version)"
          poetry run playwright --version || echo "Playwright not available"
