name: Rollback ECS Deployment

on:
  workflow_dispatch:
    inputs:
      task_definition_revision:
        description: 'Task definition revision to rollback to (e.g., "5") or "previous" for last revision'
        required: true
        default: 'previous'

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Get current and target task definitions
      id: task-definitions
      run: |
        # Get current task definition revision
        CURRENT_REVISION=$(aws ecs describe-services \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services ${{ secrets.ECS_SERVICE }} \
          --query 'services[0].taskDefinition' \
          --output text | grep -o '[0-9]*$')
        
        echo "Current revision: $CURRENT_REVISION"
        
        if [ "${{ github.event.inputs.task_definition_revision }}" = "previous" ]; then
          # Get the previous revision (current - 1)
          TARGET_REVISION=$((CURRENT_REVISION - 1))
        else
          # Use specified revision
          TARGET_REVISION="${{ github.event.inputs.task_definition_revision }}"
        fi
        
        if [ "$TARGET_REVISION" -lt 1 ]; then
          echo "‚ùå Invalid target revision: $TARGET_REVISION"
          exit 1
        fi
        
        # Get task definition family from current service
        TASK_DEF_FAMILY=$(aws ecs describe-services \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services ${{ secrets.ECS_SERVICE }} \
          --query 'services[0].taskDefinition' \
          --output text | cut -d':' -f1 | cut -d'/' -f2)
        
        TARGET_TASK_DEF="$TASK_DEF_FAMILY:$TARGET_REVISION"
        
        # Verify target task definition exists
        aws ecs describe-task-definition --task-definition "$TARGET_TASK_DEF" > /dev/null
        if [ $? -ne 0 ]; then
          echo "‚ùå Target task definition not found: $TARGET_TASK_DEF"
          echo "Available revisions:"
          aws ecs list-task-definitions --family-prefix "$TASK_DEF_FAMILY" --status ACTIVE
          exit 1
        fi
        
        echo "current-revision=$CURRENT_REVISION" >> $GITHUB_OUTPUT
        echo "target-revision=$TARGET_REVISION" >> $GITHUB_OUTPUT
        echo "target-task-def=$TARGET_TASK_DEF" >> $GITHUB_OUTPUT

    - name: Rollback ECS service
      run: |
        echo "Rolling back ECS service to task definition: ${{ steps.task-definitions.outputs.target-task-def }}"
        
        # Update the service with the target task definition
        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --service ${{ secrets.ECS_SERVICE }} \
          --task-definition ${{ steps.task-definitions.outputs.target-task-def }}
        
        echo "‚úÖ Rollback initiated"

    - name: Wait for rollback to complete
      run: |
        echo "Waiting for rollback deployment to stabilize..."
        
        # Wait for service stability (this can take several minutes)
        aws ecs wait services-stable \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services ${{ secrets.ECS_SERVICE }}
        
        echo "‚úÖ Rollback deployment completed"

    - name: Get rollback deployment details
      id: rollback-info
      run: |
        # Get service details after rollback
        CURRENT_TASK_DEF_ARN=$(aws ecs describe-services \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services ${{ secrets.ECS_SERVICE }} \
          --query 'services[0].taskDefinition' \
          --output text)
        
        echo "task-definition-arn=$CURRENT_TASK_DEF_ARN" >> $GITHUB_OUTPUT
        
        # Try to get load balancer URL using the same logic as deploy workflow
        LB_URL=$(aws elbv2 describe-load-balancers \
          --query 'LoadBalancers[?contains(LoadBalancerName, `trendsearth`) == `true`].DNSName' \
          --output text 2>/dev/null || echo "")
        
        # Fallback to service URL secret if available
        if [ -z "$LB_URL" ]; then
          LB_URL="${{ secrets.ECS_SERVICE_URL }}"
        fi
        
        echo "lb-url=$LB_URL" >> $GITHUB_OUTPUT

    - name: Verify rollback
      run: |
        # Check service status
        RUNNING_COUNT=$(aws ecs describe-services \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services ${{ secrets.ECS_SERVICE }} \
          --query 'services[0].runningCount' \
          --output text)
        
        DESIRED_COUNT=$(aws ecs describe-services \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services ${{ secrets.ECS_SERVICE }} \
          --query 'services[0].desiredCount' \
          --output text)
        
        echo "Service status: $RUNNING_COUNT/$DESIRED_COUNT tasks running"
        echo "Current task definition: ${{ steps.rollback-info.outputs.task-definition-arn }}"
        
        if [ "$RUNNING_COUNT" -eq "$DESIRED_COUNT" ] && [ "$RUNNING_COUNT" -gt 0 ]; then
          echo "‚úÖ ECS service is running with desired capacity after rollback"
        else
          echo "‚ùå ECS service is not running properly after rollback"
          exit 1
        fi
        
        # Health check if URL is available
        LB_URL="${{ steps.rollback-info.outputs.lb-url }}"
        if [ -n "$LB_URL" ]; then
          echo "Performing health check on $LB_URL"
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "http://$LB_URL/api-ui-health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Health check passed after rollback (attempt $i)"
              echo "Application URL: http://$LB_URL"
              break
            else
              echo "‚è≥ Health check failed (attempt $i), retrying in 15 seconds..."
              if [ $i -eq 10 ]; then
                echo "‚ö†Ô∏è Health check failed after rollback, but ECS service is running"
                echo "This may be due to application startup time or configuration"
              fi
              sleep 15
            fi
          done
        else
          echo "‚ö†Ô∏è No load balancer URL configured, skipping health check"
        fi

    - name: Rollback notification
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "üîÑ ECS rollback completed successfully!"
          echo "ECS Cluster: ${{ secrets.ECS_CLUSTER }}"
          echo "ECS Service: ${{ secrets.ECS_SERVICE }}"
          echo "Rolled back from revision: ${{ steps.task-definitions.outputs.current-revision }}"
          echo "Rolled back to revision: ${{ steps.task-definitions.outputs.target-revision }}"
          echo "Task Definition: ${{ steps.rollback-info.outputs.task-definition-arn }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Rollback time: $(date -u)"
          
          # Show application URL if available
          LB_URL="${{ steps.rollback-info.outputs.lb-url }}"
          if [ -n "$LB_URL" ]; then
            echo "Application URL: http://$LB_URL"
          fi
        else
          echo "üí• ECS rollback failed!"
          echo "Manual intervention may be required."
          echo "Check ECS console for service status and logs."
          echo "Current task definition may need manual reversion."
        fi

    - name: Notify Rollbar of rollback
      if: always()
      run: |
        # Notify Rollbar of rollback deployment
        if [ -n "${{ secrets.ROLLBAR_ACCESS_TOKEN }}" ]; then
          echo "üì° Notifying Rollbar of rollback..."
          
          # Try to get the actual commit SHA from the target task definition environment variables
          COMMIT_SHA=$(aws ecs describe-task-definition \
            --task-definition "${{ steps.task-definitions.outputs.target-task-def }}" \
            --query 'taskDefinition.containerDefinitions[0].environment[?name==`GIT_COMMIT`].value' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$COMMIT_SHA" ] || [ "$COMMIT_SHA" = "None" ]; then
            COMMIT_SHA="rollback-${{ steps.task-definitions.outputs.target-revision }}"
          fi
          
          if [ "${{ job.status }}" = "success" ]; then
            DEPLOY_STATUS="succeeded"
            COMMENT="Rollback deployment via GitHub Actions to task definition revision ${{ steps.task-definitions.outputs.target-revision }}"
          else
            DEPLOY_STATUS="failed"
            COMMENT="Rollback deployment failed via GitHub Actions"
          fi
          
          RESPONSE=$(curl -s -X POST https://api.rollbar.com/api/1/deploy/ \
            -H "X-Rollbar-Access-Token: ${{ secrets.ROLLBAR_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "environment": "production",
              "revision": "'"$COMMIT_SHA"'",
              "rollbar_name": "${{ github.actor }}",
              "local_username": "${{ github.actor }}",
              "comment": "'"$COMMENT"'",
              "status": "'"$DEPLOY_STATUS"'"
            }')
          
          if echo "$RESPONSE" | grep -q '"err":0'; then
            echo "‚úÖ Rollbar rollback notification sent successfully"
          else
            echo "‚ö†Ô∏è Failed to notify Rollbar of rollback"
            echo "Response: $RESPONSE"
          fi
        else
          echo "‚ö†Ô∏è ROLLBAR_ACCESS_TOKEN not configured, skipping Rollbar notification"
        fi
